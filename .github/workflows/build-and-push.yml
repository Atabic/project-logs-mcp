# CI/CD workflow for ERP MCP server:
#   - Tests run on push to main, PRs to main, version tags, and manual dispatch
#   - Release images (vX.Y.Z tags):  vX.Y.Z
#   - Dev images (manual dispatch): dev-<short-sha>  and  dev-latest
#
# Trigger a dev build:
#   gh workflow run build-and-push.yml --ref refactor/fastmcp-v3
#   (or via GitHub UI: Actions > Build and Push to ECR > Run workflow > select branch)

name: Build and Push to ECR

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      push_image:
        description: 'Push image to ECR (uncheck for build-only test)'
        type: boolean
        default: true

permissions: {}

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY: erp-mcp

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: test-${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12.8'
          cache: 'pip'
          cache-dependency-path: |
            requirements.lock
            requirements-dev.lock

      - name: Install dependencies
        run: pip install -r requirements-dev.lock

      - name: Lint
        run: ruff check .

      - name: Type check
        run: mypy server.py erp_client.py

      - name: Test
        run: pytest tests/ -v --junitxml=test-results.xml
        env:
          GOOGLE_CLIENT_ID: test-client-id
          GOOGLE_CLIENT_SECRET: test-client-secret
          MCP_BASE_URL: http://localhost:8100
          ERP_API_BASE_URL: http://127.0.0.1:8000/api/v1
          ALLOWED_DOMAIN: arbisoft.com

  build-and-push:
    needs: test
    if: ${{ startsWith(github.ref, 'refs/tags/v') && github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ecr-push-${{ github.ref_name }}
      cancel-in-progress: false
    permissions:
      id-token: write
      contents: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Verify required secrets
        run: |
          if [ -z "$ROLE_ARN" ]; then
            echo '::error::AWS_ECR_ROLE_ARN secret is not set. Configure it in repository settings.'
            exit 1
          fi
        env:
          ROLE_ARN: ${{ secrets.AWS_ECR_ROLE_ARN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_ECR_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@4625ce35226a7557230889aae2f52eb50ec3dcda # v2.0.1

      - name: Extract and validate version tag
        id: meta
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          if ! echo "$VERSION" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Tag '$VERSION' does not match semver pattern vX.Y.Z"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      # Step 1: Build locally (do not push yet) for vulnerability scanning
      - name: Build Docker image (local)
        id: build-local
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v6.15.0
        with:
          context: .
          push: false
          load: true
          build-args: |
            APP_VERSION=${{ steps.meta.outputs.version }}
          tags: |
            ${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}
          cache-from: type=gha,scope=main
          cache-to: type=gha,mode=max,scope=main

      # Step 2: Gate on HIGH+CRITICAL vulnerabilities before push
      # ignore-unfixed: true is intentional — blocks only on vulnerabilities with
      # available patches. Known unfixed CVEs are tracked via the advisory scan
      # (exit-code: 0) which uploads SARIF to GitHub Security tab.
      - name: Trivy scan (gate - HIGH+CRITICAL)
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          image-ref: ${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}
          format: 'table'
          severity: 'HIGH,CRITICAL'
          vuln-type: 'os,library'
          ignore-unfixed: true
          exit-code: '1'

      # Step 3: Push to ECR only after scan passes
      - name: Push Docker image to ECR
        id: build-push
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v6.15.0
        with:
          context: .
          push: true
          build-args: |
            APP_VERSION=${{ steps.meta.outputs.version }}
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}
          cache-from: type=gha,scope=main
          cache-to: type=gha,mode=max,scope=main

      # Step 4: Full advisory scan (HIGH+CRITICAL) for GitHub Security tab
      - name: Trivy scan (advisory - SARIF upload)
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          vuln-type: 'os,library'
          ignore-unfixed: true
          exit-code: '0'

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@c4a7bc332abaec03596ff2803dd7f3ca3a238975 # v3 (pinned)
        if: ${{ always() && steps.build-push.outcome == 'success' }}
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'container-scan-release'

      - name: Output image summary
        run: |
          echo '## Docker Image Published' >> "$GITHUB_STEP_SUMMARY"
          echo '| Field | Value |' >> "$GITHUB_STEP_SUMMARY"
          echo '|-------|-------|' >> "$GITHUB_STEP_SUMMARY"
          echo "| Repository | $ECR_REPO |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Tag | $VERSION |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Digest | $DIGEST |" >> "$GITHUB_STEP_SUMMARY"
        env:
          ECR_REPO: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          VERSION: ${{ steps.meta.outputs.version }}
          DIGEST: ${{ steps.build-push.outputs.digest }}

  # ──────────────────────────────────────────────────────────────
  # Dev build: manually triggered via workflow_dispatch from any branch.
  # Produces images tagged  dev-<7-char-sha>  and  dev-latest.
  # Tests must pass first (needs: test).
  # ──────────────────────────────────────────────────────────────
  build-and-push-dev:
    needs: test
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: ecr-push-dev
      cancel-in-progress: false
    permissions:
      id-token: write
      contents: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Verify required secrets
        run: |
          if [ -z "$ROLE_ARN" ]; then
            echo '::error::AWS_ECR_ROLE_ARN secret is not set. Configure it in repository settings.'
            exit 1
          fi
        env:
          ROLE_ARN: ${{ secrets.AWS_ECR_ROLE_ARN }}

      - name: Compute dev image tag
        id: meta
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          BRANCH_NAME="${GITHUB_REF_NAME}"
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          echo "dev_tag=dev-$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722 # v4.1.0
        with:
          role-to-assume: ${{ secrets.AWS_ECR_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@4625ce35226a7557230889aae2f52eb50ec3dcda # v2.0.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      # ── Push path: build locally → scan → push → SARIF scan ──
      - name: Build Docker image (local)
        if: ${{ inputs.push_image }}
        id: build-local
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v6.15.0
        with:
          context: .
          push: false
          load: true
          build-args: |
            APP_VERSION=${{ steps.meta.outputs.dev_tag }}
          tags: |
            ${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.dev_tag }}
          cache-from: |
            type=gha,scope=${{ github.ref_name }}
            type=gha,scope=main
          cache-to: type=gha,scope=${{ github.ref_name }},mode=max

      - name: Trivy scan (gate - HIGH+CRITICAL)
        if: ${{ inputs.push_image }}
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          image-ref: ${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.dev_tag }}
          format: 'table'
          severity: 'HIGH,CRITICAL'
          vuln-type: 'os,library'
          ignore-unfixed: true
          exit-code: '1'

      - name: Push Docker image to ECR
        if: ${{ inputs.push_image }}
        id: build-push
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v6.15.0
        with:
          context: .
          push: true
          build-args: |
            APP_VERSION=${{ steps.meta.outputs.dev_tag }}
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.dev_tag }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-latest
          cache-from: |
            type=gha,scope=${{ github.ref_name }}
            type=gha,scope=main
          cache-to: type=gha,scope=${{ github.ref_name }},mode=max

      - name: Trivy scan (advisory - SARIF upload)
        if: ${{ inputs.push_image }}
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.dev_tag }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          vuln-type: 'os,library'
          ignore-unfixed: true
          exit-code: '0'

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@c4a7bc332abaec03596ff2803dd7f3ca3a238975 # v3 (pinned)
        if: ${{ always() && inputs.push_image && steps.build-push.outcome == 'success' }}
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'container-scan-dev'

      # ── No-push path: build locally → scan (table, blocking) ──
      - name: Build only (no push)
        if: ${{ !inputs.push_image }}
        id: build-only
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v6.15.0
        with:
          context: .
          push: false
          load: true
          build-args: |
            APP_VERSION=${{ steps.meta.outputs.dev_tag }}
          tags: |
            ${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.dev_tag }}
          cache-from: |
            type=gha,scope=${{ github.ref_name }}
            type=gha,scope=main
          cache-to: type=gha,scope=${{ github.ref_name }},mode=max

      - name: Trivy scan (no-push gate - HIGH+CRITICAL)
        if: ${{ !inputs.push_image }}
        uses: aquasecurity/trivy-action@915b19bbe73b92a6cf82a1bc12b087c9a19a5fe2 # 0.28.0
        with:
          image-ref: ${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.dev_tag }}
          format: 'table'
          severity: 'HIGH,CRITICAL'
          vuln-type: 'os,library'
          ignore-unfixed: true
          exit-code: '1'

      - name: Output image summary
        if: ${{ inputs.push_image }}
        run: |
          echo '## Dev Docker Image Published' >> "$GITHUB_STEP_SUMMARY"
          echo '| Field | Value |' >> "$GITHUB_STEP_SUMMARY"
          echo '|-------|-------|' >> "$GITHUB_STEP_SUMMARY"
          echo "| Repository | $ECR_REPO |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Tag | $DEV_TAG |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Branch | $BRANCH |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Commit | $SHORT_SHA |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Digest | $DIGEST |" >> "$GITHUB_STEP_SUMMARY"
          echo '' >> "$GITHUB_STEP_SUMMARY"
          echo "Pull command:" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "docker pull $ECR_REPO:$DEV_TAG" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
        env:
          ECR_REPO: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          DEV_TAG: ${{ steps.meta.outputs.dev_tag }}
          BRANCH: ${{ steps.meta.outputs.branch }}
          SHORT_SHA: ${{ steps.meta.outputs.short_sha }}
          DIGEST: ${{ steps.build-push.outputs.digest }}
